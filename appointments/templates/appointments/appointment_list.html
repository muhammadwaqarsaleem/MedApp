<!{# ============================================================================
   appointments/appointment_list.html
   Purpose:
     - Display a list of appointments for the logged-in user.
     - Use card layout with status-based styling.
     - Include cancel buttons for upcoming appointments.
     - Integrate breadcrumbs, status filter tabs, and modal confirmation.
   Context expected:
     - appointments: list of Appointment objects
     - crumbs: breadcrumb trail (list of {label, url})
     - status_filter: current filter ("pending", "confirmed", "completed", "cancelled")
   ============================================================================ #}-->

{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container my-4">

  {# Breadcrumbs for navigation context #}
  {% include 'includes/breadcrumbs.html' with crumbs=crumbs %}

  <h2 class="mb-3">My Appointments</h2>
  <p class="text-muted">Manage your upcoming, completed, and cancelled appointments.</p>

  {# Status filter tabs #}
  <ul class="nav nav-tabs mb-4">
    <li class="nav-item">
      <a class="nav-link {% if not status_filter %}active{% endif %}" href="?">All</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if status_filter == 'pending' %}active{% endif %}" href="?status=pending">Pending</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if status_filter == 'confirmed' %}active{% endif %}" href="?status=confirmed">Confirmed</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if status_filter == 'completed' %}active{% endif %}" href="?status=completed">Completed</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if status_filter == 'cancelled' %}active{% endif %}" href="?status=cancelled">Cancelled</a>
    </li>
  </ul>

  {% if appointments %}
    <div class="appointment-list">
      {% for appointment in appointments %}
        <div class="appointment-card card mb-3 p-3 shadow-sm">
          <div class="row">
            <div class="col-md-8">
              <h5 class="mb-1">{{ appointment.doctor.get_full_name }}</h5>
              <p class="mb-1"><strong>Date:</strong> {{ appointment.scheduled_time|date:"M d, Y" }}</p>
              <p class="mb-1"><strong>Time:</strong> {{ appointment.scheduled_time|time:"h:i A" }}</p>
              <p class="mb-1"><strong>Reason:</strong> {{ appointment.reason|default:"â€”" }}</p>
            </div>

            <div class="col-md-4 text-end">
              {# Status badge using reusable component #}
              {% include "components/badge.html" with label=appointment.get_status_display variant=appointment.status only %}

              {% if appointment.status == 'pending' or appointment.status == 'confirmed' %}
                <button class="btn btn-outline-danger btn-sm mt-2"
                        onclick="openConfirmModal('{{ appointment.id }}')">
                  Cancel
                </button>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">
      You have no appointments yet. <a href="{% url 'appointments:create' %}">Book one now</a>.
    </div>
  {% endif %}

  {# Modal for confirming cancellation #}
  <div class="modal fade" id="confirmCancelModal" tabindex="-1" aria-labelledby="confirmCancelLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmCancelLabel">Confirm Cancellation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to cancel this appointment?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <form id="cancelForm" method="post" action="">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Cancel Appointment</button>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>

{# JS for handling cancellation modal #}
<script>
  function openConfirmModal(appointmentId) {
    const modal = new bootstrap.Modal(document.getElementById('confirmCancelModal'));
    const cancelForm = document.getElementById('cancelForm');
    cancelForm.action = `/appointments/${appointmentId}/cancel/`;  // adjust route to your cancel view
    modal.show();
  }
</script>
{% endblock %}
